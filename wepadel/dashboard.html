<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard â€“ CafÃ©Misu Ã— We Padel</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        padding: 20px;
        background: #F9F5F1;
        font-family: 'Playfair Display', serif;
        color: #7a5b47;
    }

    h1 {
        text-align: center;
        margin-bottom: 15px;
        font-size: 2rem;
        font-weight: 700;
    }

    /* ----------- FILTER BAR ----------- */

    .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        justify-content: center;
    }

    .filter-btn {
        padding: 8px 14px;
        border-radius: 6px;
        border: 1px solid #A87555;
        background: #fff;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .filter-active {
        background: #A87555;
        color: #fff;
        border-color: #A87555;
    }

    /* ----------- DATE FILTER ----------- */

    .date-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 15px;
        align-items: center;
    }

    .date-bar input {
        padding: 7px;
        border-radius: 6px;
        border: 1px solid #A87555;
        font-size: 0.9rem;
    }

    .date-bar button {
        padding: 7px 14px;
        background: #A87555;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    /* ----------- EXPORT ----------- */

    .export-bar {
        text-align: center;
        margin-bottom: 20px;
    }

    .export-btn {
        padding: 7px 14px;
        margin: 0 6px;
        background: #7C3AED;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
    }

    /* ----------- CARDS ----------- */

    .section-title {
        font-size: 1.4rem;
        margin-top: 25px;
        margin-bottom: 10px;
        font-weight: 700;
        text-align: center;
        color: #A87555;
    }

    .card {
        background: #fff;
        padding: 20px;
        border-radius: 16px;
        margin: 20px 0;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .table-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #A87555;
    }

    .buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .status-btn {
        padding: 8px 14px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 0.9rem;
        color: white;

        /* Default = grey */
        background: #6B7280;
    }

    /* COLORS BY STATUS */
    .status-new.active { background: #DC2626 !important; }     /* RED */
    .status-served.active { background: #22C55E !important; }  /* GREEN */
    .status-paid.active { background: #22C55E !important; }    /* GREEN */
    .status-done.active { background: #7C3AED !important; }    /* PURPLE */

    ul {
        padding-left: 20px;
        margin: 10px 0;
    }

    .client, .date {
        margin-top: 5px;
        font-size: 0.95rem;
    }

    /* TERMINER BUTTON */
    .terminate-btn {
        margin-top: 14px;
        padding: 7px 12px;
        background: #7C3AED;
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        float: right;
    }

</style>
</head>
<body>

<h1>ðŸ“‹ Dashboard â€“ CafÃ©Misu Ã— We Padel</h1>

<!-- DATE FILTER -->
<div class="date-bar">
    <span>ðŸ“… Du :</span>
    <input type="date" id="from-date">
    <span>Au :</span>
    <input type="date" id="to-date">
    <button id="apply-date">Appliquer</button>
    <button id="today-btn">Aujourdâ€™hui</button>
</div>

<!-- STATUS FILTER -->
<div class="filters">
    <button class="filter-btn" data-filter="all">Toutes</button>
    <button class="filter-btn" data-filter="new">Nouvelle commande</button>
    <button class="filter-btn" data-filter="served">Servies</button>
    <button class="filter-btn" data-filter="paid">PayÃ©es</button>
    <button class="filter-btn" data-filter="done">TerminÃ©es</button>
</div>

<!-- EXPORT -->
<div class="export-bar">
    <button class="export-btn" id="export-pdf">ðŸ“„ Export PDF</button>
    <button class="export-btn" id="export-csv">ðŸ“Š Export CSV</button>
</div>

<!-- SECTIONS -->
<div class="section-title">Commandes actives</div>
<div id="active-orders"></div>

<div class="section-title">Commandes terminÃ©es</div>
<div id="done-orders"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, updateDoc, doc }
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import jsPDF from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";

    const firebaseConfig = {
        apiKey: "AIzaSyDb7QI70lVF5vhQahUau5z2E7QOvdte9Y",
        authDomain: "cafemisu-wepadel.firebaseapp.com",
        projectId: "cafemisu-wepadel",
        storageBucket: "cafemisu-wepadel.appspot.com",
        messagingSenderId: "184586399626",
        appId: "1:184586399626:web:382a3671ca9b32baba4273"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let selectedFilter = "all";
    let dateFrom = null;
    let dateTo = null;

    const activeDiv = document.getElementById("active-orders");
    const doneDiv  = document.getElementById("done-orders");

    const q = query(collection(db, "orders"), orderBy("createdAt", "asc"));

    onSnapshot(q, (snapshot) => {
        const orders = [];
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            orders.push({ id: docSnap.id, ...data });
        });

        renderOrders(orders);
    });

    function matchesFilter(order) {
        if (selectedFilter === "all") return order.status !== "done";
        return order.status === selectedFilter;
    }

    function matchesDate(order) {
        if (!order.createdAt) return false;
        const t = order.createdAt.toDate();

        if (dateFrom && t < dateFrom) return false;
        if (dateTo && t > dateTo) return false;

        return true;
    }

    function renderOrders(list) {
        activeDiv.innerHTML = "";
        doneDiv.innerHTML = "";

        list.forEach(order => {
            if (!matchesDate(order) || !matchesFilter(order)) return;

            const card = document.createElement("div");
            card.className = "card";

            const created = order.createdAt?.toDate().toLocaleString("fr-FR") || "â€”";
            const items = order.items.map(i => `<li>${i.name} â€” ${i.price.toLocaleString()} FCFA</li>`).join("");

            card.innerHTML = `
                <div class="card-header">
                    <div class="table-number">Table ${order.table}</div>

                    <div class="buttons">
                        <button class="status-btn status-new ${order.status === 'new' ? 'active' : ''}"
                                data-id="${order.id}" data-status="new">Nouvelle commande</button>

                        <button class="status-btn status-served ${order.status === 'served' ? 'active' : ''}"
                                data-id="${order.id}" data-status="served">Servi</button>

                        <button class="status-btn status-paid ${order.status === 'paid' ? 'active' : ''}"
                                data-id="${order.id}" data-status="paid">PayÃ©</button>

                        <button class="status-btn status-done ${order.status === 'done' ? 'active' : ''}"
                                data-id="${order.id}" data-status="done">TerminÃ©</button>
                    </div>
                </div>

                <ul>${items}</ul>

                <div class="client">Client : ${order.name || "â€”"}</div>
                <div class="date">ReÃ§u : ${created}</div>

                <button class="terminate-btn" data-id="${order.id}">Terminer</button>
            `;

            if (order.status === "done") {
                doneDiv.appendChild(card);
            } else {
                activeDiv.appendChild(card);
            }

            card.querySelectorAll(".status-btn").forEach(btn => {
                btn.addEventListener("click", async () => {
                    const id = btn.dataset.id;
                    const newStatus = btn.dataset.status;

                    await updateDoc(doc(db, "orders", id), { status: newStatus });
                });
            });

            card.querySelector(".terminate-btn").addEventListener("click", async () => {
                await updateDoc(doc(db, "orders", order.id), { status: "done" });
            });
        });
    }

    document.querySelectorAll(".filter-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("filter-active"));
            btn.classList.add("filter-active");

            selectedFilter = btn.dataset.filter;
            onSnapshot(q, snapshot => {
                const orders=[];
                snapshot.forEach(docSnap => orders.push({id:docSnap.id,...docSnap.data()}));
                renderOrders(orders);
            });
        });
    });

    document.getElementById("apply-date").addEventListener("click", () => {
        dateFrom = document.getElementById("from-date").value ? new Date(document.getElementById("from-date").value+" 00:00:00") : null;
        dateTo = document.getElementById("to-date").value ? new Date(document.getElementById("to-date").value+" 23:59:59") : null;

        onSnapshot(q, snapshot => {
            const orders=[];
            snapshot.forEach(docSnap => orders.push({id:docSnap.id,...docSnap.data()}));
            renderOrders(orders);
        });
    });

    document.getElementById("today-btn").addEventListener("click", () => {
        const now = new Date();
        const iso = now.toISOString().split("T")[0];

        document.getElementById("from-date").value = iso;
        document.getElementById("to-date").value   = iso;

        dateFrom = new Date(iso+" 00:00:00");
        dateTo   = new Date(iso+" 23:59:59");

        onSnapshot(q, snapshot => {
            const orders=[];
            snapshot.forEach(docSnap => orders.push({id:docSnap.id,...docSnap.data()}));
            renderOrders(orders);
        });
    });

    /* EXPORT CSV */
    document.getElementById("export-csv").addEventListener("click", () => {
        let csv = "Table,Nom,Statut,Date,Articles\n";

        const rows = [...activeDiv.children, ...doneDiv.children];

        rows.forEach(card => {
            const table = card.querySelector(".table-number").innerText.replace("Table ","");
            const name = card.querySelector(".client").innerText.replace("Client : ","");
            const date = card.querySelector(".date").innerText.replace("ReÃ§u : ","");

            const items = [...card.querySelectorAll("ul li")].map(li => li.innerText).join(" | ");

            const status = [...card.querySelectorAll(".status-btn.active")][0]?.dataset.status || "â€”";

            csv += `${table},${name},${status},${date},"${items}"\n`;
        });

        const blob = new Blob([csv], {type: "text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "commandes.csv";
        a.click();
    });

    /* EXPORT PDF */
    document.getElementById("export-pdf").addEventListener("click", () => {
        const pdf = new jsPDF();
        let y = 10;

        pdf.setFontSize(16);
        pdf.text("Rapport des commandes CafÃ©Misu Ã— We Padel", 10, y);
        y += 10;
        pdf.setFontSize(12);

        const rows = [...activeDiv.children, ...doneDiv.children];

        rows.forEach(card => {
            if (y > 270) { pdf.addPage(); y = 10; }

            const table = card.querySelector(".table-number").innerText;
            const name  = card.querySelector(".client").innerText;
            const date  = card.querySelector(".date").innerText;
            const items = [...card.querySelectorAll("ul li")].map(li => li.innerText);

            pdf.text(table, 10, y);
            y += 6;
            pdf.text(name, 10, y);
            y += 6;
            pdf.text(date, 10, y);
            y += 6;

            items.forEach(i => {
                pdf.text(" - " + i, 14, y);
                y += 6;
            });

            y += 6;
        });

        pdf.save("commandes.pdf");
    });

</script>

</body>
</html>
