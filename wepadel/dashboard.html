<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard â€“ CafÃ©Misu Ã— We Padel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Export libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        font-family: 'Playfair Display', serif;
        background: #F7EFEA;
        margin: 0;
        padding: 20px;
        color: #5D3A2C;
    }

    h1 { text-align:center; margin-bottom:25px; }

    .filter-bar {
        display:flex;
        gap:10px;
        justify-content:center;
        margin-bottom:20px;
    }

    .filter-btn {
        padding:10px 18px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        font-size:15px;
        background:#E5D8CF;
        color:#5D3A2C;
    }

    .active { background:#5D3A2C !important; color:white !important; }

    #export-bar {
        display:flex; justify-content:center; gap:10px; margin-bottom:20px;
    }

    .order-card {
        position:relative;
        background:white;
        padding:20px;
        margin-bottom:20px;
        border-radius:12px;
        box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }

    /* Petit bouton X */
    .delete-btn {
        position:absolute;
        top:10px;
        right:10px;
        background:#d9534f;
        color:white;
        border:none;
        border-radius:50%;
        width:24px;
        height:24px;
        font-size:14px;
        cursor:pointer;
    }

    .badge {
        display:inline-block;
        padding:6px 12px;
        border-radius:20px;
        font-size:14px;
        color:white;
        margin-bottom:10px;
    }

    .badge-new { background:#A87555; }
    .badge-served { background:#3B82F6; }
    .badge-paid { background:#EAB308; color:black; }
    .badge-done { background:#22C55E; }

    .btn-actions {
        display:flex;
        gap:6px;
        flex-wrap:wrap;
        margin-top:15px;
    }

    .action-btn {
        padding:8px 14px;
        border:none;
        border-radius:8px;
        cursor:pointer;
        color:white;
        font-size:14px;
    }

    .btn-new { background:#A87555; }
    .btn-served { background:#3B82F6; }
    .btn-paid { background:#EAB308; color:black; }
    .btn-done { background:#22C55E; }
</style>
</head>

<body>

<h1>ðŸ“‹ Commandes â€“ CafÃ©Misu Ã— We Padel</h1>

<!-- FILTRES -->
<div class="filter-bar">
    <button class="filter-btn active" onclick="setFilter('active')">Commandes actives</button>
    <button class="filter-btn" onclick="setFilter('done')">Commandes terminÃ©es</button>
    <button class="filter-btn" onclick="setFilter('all')">Toutes</button>
</div>

<!-- DATE -->
<div class="filter-bar">
    <input type="date" id="dateFilter" onchange="loadOrders()" class="filter-btn" style="padding:8px 12px;">
</div>

<!-- TRI -->
<div class="filter-bar">
    <button class="filter-btn" onclick="toggleSort()">ðŸ“… Trier par date (asc/desc)</button>
</div>

<!-- EXPORT -->
<div id="export-bar">
    <button class="filter-btn" onclick="exportXLS()">Exporter XLS</button>
    <button class="filter-btn" onclick="exportPDF()">Exporter PDF</button>
</div>

<div id="orders"></div>

<script>
/* ---------------- FIREBASE ---------------- */
const firebaseConfig = {
    apiKey: "AIzaSyDb7QDl0VF5vhQahUaua5z2EzYQovdt9Y",
    authDomain: "cafemisu-wepadel.firebaseapp.com",
    projectId: "cafemisu-wepadel",
    storageBucket: "cafemisu-wepadel.appspot.com",
    messagingSenderId: "158465399626",
    appId: "1:158465399626:web:382a8671ca9b32b3aba4273"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* FILTRES */
let currentFilter = "active";
let sortDirection = "desc";

function setFilter(f) {
    currentFilter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    loadOrders();
}

/* CHARGEMENT COMMANDES */
function loadOrders() {
    db.collection("orders")
      .orderBy("timestamp", sortDirection)
      .onSnapshot(snap => {
        let html = "";
        const all = [];

        const selectedDate = document.getElementById("dateFilter").value;

        snap.forEach(doc => {
            const o = doc.data();
            o.id = doc.id;

            if (currentFilter === "active" && o.status === "done") return;
            if (currentFilter === "done" && o.status !== "done") return;

            if (selectedDate) {
                const orderDate = o.time?.split(" ")[0];
                const [d,m,y] = orderDate.split("/");
                if (`${y}-${m}-${d}` !== selectedDate) return;
            }

            all.push(o);
            html += generateCard(o);
        });

        window._exportData = all;
        document.getElementById("orders").innerHTML = html;
      });
}

/* CARTE */
function generateCard(o) {

    const total = o.items.reduce((sum, i) => sum + i.price, 0);

    const badge =
        o.status === "new"    ? `<span class="badge badge-new">ðŸŸ« new</span>` :
        o.status === "served" ? `<span class="badge badge-served">ðŸŸ¦ served</span>` :
        o.status === "paid"   ? `<span class="badge badge-paid">ðŸŸ¨ paid</span>` :
                                `<span class="badge badge-done">ðŸŸ© done</span>`;

    return `
    <div class="order-card">
        <button class="delete-btn" onclick="deleteOrder('${o.id}')">Ã—</button>

        <h2>Table ${o.table}</h2>
        ${badge}

        <ul>
            ${o.items.map(i => `<li>${i.name} â€” ${i.price} FCFA</li>`).join("")}
        </ul>

        <p><b>Total :</b> ${total.toLocaleString()} FCFA</p>
        <p><b>Client :</b> ${o.customer}</p>
        <p><b>Heure :</b> ${o.time}</p>

        <div class="btn-actions">
            <button class="action-btn btn-new" onclick="updateStatus('${o.id}','new')">new</button>
            <button class="action-btn btn-served" onclick="updateStatus('${o.id}','served')">served</button>
            <button class="action-btn btn-paid" onclick="updateStatus('${o.id}','paid')">paid</button>
            <button class="action-btn btn-done" onclick="updateStatus('${o.id}','done')">Terminer</button>
        </div>
    </div>`;
}

/* UPDATE STATUT */
function updateStatus(id, status) {
    db.collection("orders").doc(id).update({ status });
}

/* DELETE ORDER */
function deleteOrder(id) {
    if (!confirm("Supprimer dÃ©finitivement cette commande ?")) return;

    db.collection("orders").doc(id).delete();
}

/* EXPORT XLS */
function exportXLS() {
    const ws = XLSX.utils.json_to_sheet(window._exportData || []);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Commandes");
    XLSX.writeFile(wb, "commandes.xlsx");
}

/* EXPORT PDF */
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 10;

    (window._exportData || []).forEach(o => {
        const total = o.items.reduce((s, i) => s + i.price, 0);

        pdf.text(`Table ${o.table} | ${o.time} | ${o.status} | Total: ${total} FCFA`, 10, y); 
        y += 8;

        o.items.forEach(i => { 
            pdf.text(`- ${i.name} : ${i.price} FCFA`, 14, y); 
            y += 6; 
        });

        y += 8;
    });

    pdf.save("commandes.pdf");
}

/* TRI */
function toggleSort() {
    sortDirection = sortDirection === "desc" ? "asc" : "desc";
    loadOrders();
}

loadOrders();
</script>

</body>
</html>
