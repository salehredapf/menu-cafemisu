<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard â€“ CafÃ©Misu Ã— We Padel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Export libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body {
        margin: 0;
        padding: 20px;
        background: #F5F5F7;
        font-family: Arial, sans-serif;
        color: #333;
    }

    h1 {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 20px;
        font-weight: 700;
    }

    /* --- TOP BAR KPIs --- */
    .kpi-bar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
    }

    .kpi {
        background: white;
        padding: 14px 22px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.07);
        font-size: 1rem;
        font-weight: 600;
        text-align: center;
    }

    /* --- SEARCH --- */
    #searchBox {
        width: 96%;
        padding: 12px;
        margin: 10px auto 20px;
        display: block;
        border-radius: 10px;
        border: 2px solid #CCC;
        font-size: 1rem;
    }

    /* --- FILTER BAR --- */
    .filter-bar {
        display:flex;
        gap:10px;
        justify-content:center;
        flex-wrap:wrap;
        margin-bottom:20px;
    }

    .filter-btn {
        padding:12px 20px;
        border:none;
        border-radius:10px;
        cursor:pointer;
        background:#E5E5E5;
        font-weight:600;
        transition:0.2s;
    }

    .filter-btn:hover {
        background:#D0D0D0;
    }

    .active {
        background:#333 !important;
        color:white !important;
    }

    /* DATE */
    #dateFilter {
        padding:10px 15px;
        border-radius:10px;
        border:2px solid #CCC;
        background:white;
        font-size:1rem;
    }

    /* --- GRID RESPONSIVE --- */
    #orders {
        display:grid;
        grid-template-columns: 1fr;
        gap:18px;
    }

    @media(min-width:700px){
        #orders {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media(min-width:1100px){
        #orders {
            grid-template-columns: 1fr 1fr 1fr;
        }
    }

    /* --- ORDER CARD (POS STYLE) --- */
    .order-card {
        background:white;
        border-radius:12px;
        padding:20px;
        box-shadow:0 6px 18px rgba(0,0,0,0.12);
        position:relative;
        border-left:8px solid #333;
        transition:0.2s;
    }

    .order-card:hover {
        transform:scale(1.02);
    }

    /* DELETE BUTTON */
    .delete-btn {
        position:absolute;
        top:12px;
        right:12px;
        background:#C0392B;
        color:white;
        border:none;
        border-radius:50%;
        width:28px;
        height:28px;
        font-size:16px;
        cursor:pointer;
        font-weight:bold;
    }

    /* BADGES */
    .badge {
        display:inline-block;
        padding:6px 14px;
        border-radius:20px;
        color:white;
        font-size:0.85rem;
        font-weight:600;
        margin-bottom:10px;
    }
    .badge-new { background:#333; }
    .badge-served { background:#3498DB; }
    .badge-paid { background:#F1C40F; color:black; }
    .badge-done { background:#27AE60; }

    /* ITEMS LIST */
    ul {
        padding-left:20px;
        margin-bottom:10px;
    }
    li {
        margin-bottom:4px;
        font-size:0.95rem;
    }

    /* ACTION BUTTONS */
    .btn-actions {
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        margin-top:15px;
    }
    .action-btn {
        padding:10px 18px;
        border-radius:10px;
        border:none;
        cursor:pointer;
        font-size:0.9rem;
        font-weight:600;
        color:white;
        flex:1;
    }
    .btn-new { background:#333; }
    .btn-served { background:#3498DB; }
    .btn-paid { background:#F1C40F; color:black; }
    .btn-done { background:#27AE60; }

    /* DARK MODE */
    body.dark {
        background:#1e1e1e;
        color:white;
    }
    body.dark .order-card {
        background:#2A2A2A;
        color:white;
        border-left-color:#888;
    }
    body.dark .kpi,
    body.dark #searchBox,
    body.dark #dateFilter {
        background:#2A2A2A;
        color:white;
        border-color:#666;
    }
</style>
</head>

<body>

<h1>ðŸ“‹ Dashboard â€“ CafÃ©Misu Ã— We Padel (PRO)</h1>

<!-- KPIs -->
<div class="kpi-bar">
    <div class="kpi" id="kpi-total">Total : 0</div>
    <div class="kpi" id="kpi-active">Actives : 0</div>
    <div class="kpi" id="kpi-new">NEW : 0</div>
    <div class="kpi" id="kpi-served">Served : 0</div>
    <div class="kpi" id="kpi-paid">Paid : 0</div>
    <div class="kpi" id="kpi-done">Done : 0</div>
</div>

<!-- SEARCH -->
<input id="searchBox" placeholder="Rechercher : produit, table, clientâ€¦">

<!-- FILTERS -->
<div class="filter-bar">
    <button class="filter-btn active" onclick="setFilter('active')">Actives</button>
    <button class="filter-btn" onclick="setFilter('done')">TerminÃ©es</button>
    <button class="filter-btn" onclick="setFilter('all')">Toutes</button>
</div>

<!-- DATE -->
<div class="filter-bar">
    <input type="date" id="dateFilter" onchange="loadOrders()">
</div>

<!-- EXPORT -->
<div class="filter-bar">
    <button class="filter-btn" onclick="toggleSort()">Tri date</button>
    <button class="filter-btn" onclick="exportXLS()">Export XLS</button>
    <button class="filter-btn" onclick="exportPDF()">Export PDF</button>
    <button class="filter-btn" onclick="toggleDark()">Mode Nuit</button>
</div>

<div id="orders"></div>

<script>
/* FIREBASE */
const firebaseConfig = {
    apiKey: "AIzaSyDb7QDl0VF5vhQahUaua5z2EzYQovdt9Y",
    authDomain: "cafemisu-wepadel.firebaseapp.com",
    projectId: "cafemisu-wepadel",
    storageBucket: "cafemisu-wepadel.appspot.com",
    messagingSenderId: "158465399626",
    appId: "1:158465399626:web:382a8671ca9b32b3aba4273"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* FILTERS */
let currentFilter = "active";
let sortDirection = "desc";
let allOrders = [];

/* DARK MODE */
function toggleDark() {
    document.body.classList.toggle("dark");
}

/* SET FILTER */
function setFilter(f) {
    currentFilter = f;
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    event.target.classList.add("active");
    displayOrders();
}

/* LOAD ORDERS */
function loadOrders() {
    db.collection("orders")
      .orderBy("timestamp", sortDirection)
      .onSnapshot(snap => {

        const selectedDate = document.getElementById("dateFilter").value;
        const list = [];

        snap.forEach(doc => {
            const o = doc.data();
            o.id = doc.id;

            if (selectedDate) {
                const [d,m,y] = o.time.split(" ")[0].split("/");
                if (`${y}-${m}-${d}` !== selectedDate) return;
            }

            list.push(o);
        });

        allOrders = list;

        updateKPIs();
        displayOrders();
    });
}

/* DISPLAY ORDERS */
function displayOrders() {
    let html = "";

    const search = document.getElementById("searchBox").value.toLowerCase();

    let data = allOrders.filter(o => {
        if (currentFilter === "active" && o.status === "done") return false;
        if (currentFilter === "done" && o.status !== "done") return false;

        if (
            !o.items.some(i => i.name.toLowerCase().includes(search)) &&
            !String(o.table).includes(search) &&
            !(o.customer || "").toLowerCase().includes(search)
        ) {
            return false;
        }

        return true;
    });

    data.forEach(o => html += generateCard(o));

    document.getElementById("orders").innerHTML = html;
}

/* HUMAN TIME */
function timeAgo(orderTime) {
    const now = new Date();
    const [date, time] = orderTime.split(" ");
    const [d,m,y] = date.split("/");
    const [hh,mm] = time.split(":");

    const orderDate = new Date(y, m-1, d, hh, mm);
    const diffMin = Math.floor((now - orderDate) / 60000);

    if (diffMin < 1) return "Ã€ lâ€™instant";
    if (diffMin < 60) return diffMin + " min";
    return Math.floor(diffMin/60) + "h " + (diffMin%60) + "min";
}

/* ORDER CARD */
function generateCard(o) {

    const total = o.items.reduce((s, i) => s + i.price, 0);
    const ago = timeAgo(o.time);

    const urgency = ago.includes("min") && parseInt(ago) >= 15 
        ? "color:red;font-weight:bold;" 
        : "";

    const badge =
        o.status === "new"    ? `<span class="badge badge-new">NEW</span>` :
        o.status === "served" ? `<span class="badge badge-served">SERVED</span>` :
        o.status === "paid"   ? `<span class="badge badge-paid">PAID</span>` :
                                `<span class="badge badge-done">DONE</span>`;

    return `
    <div class="order-card">

        <button class="delete-btn" onclick="deleteOrder('${o.id}')">Ã—</button>

        <h2>Table ${o.table} <span style="${urgency}">${ago}</span></h2>
        ${badge}

        <ul>
            ${o.items.map(i => `<li>${i.name} â€” ${i.price} FCFA</li>`).join("")}
        </ul>

        <p><b>Total :</b> ${total.toLocaleString()} FCFA</p>
        <p><b>Client :</b> ${o.customer}</p>
        <p><b>Heure :</b> ${o.time}</p>

        <div class="btn-actions">
            <button class="action-btn btn-new" onclick="updateStatus('${o.id}','new')">New</button>
            <button class="action-btn btn-served" onclick="updateStatus('${o.id}','served')">Served</button>
            <button class="action-btn btn-paid" onclick="updateStatus('${o.id}','paid')">Paid</button>
            <button class="action-btn btn-done" onclick="updateStatus('${o.id}','done')">Terminer</button>
        </div>
    </div>`;
}

/* UPDATE STATUS */
function updateStatus(id, status) {
    db.collection("orders").doc(id).update({ status });
}

/* DELETE ORDER */
function deleteOrder(id) {
    if (!confirm("Supprimer dÃ©finitivement cette commande ?")) return;
    db.collection("orders").doc(id).delete();
}

/* KPIs */
function updateKPIs() {
    document.getElementById("kpi-total").innerText =
        "Total : " + allOrders.length;

    document.getElementById("kpi-active").innerText =
        "Actives : " + allOrders.filter(o => o.status !== "done").length;

    document.getElementById("kpi-new").innerText =
        "NEW : " + allOrders.filter(o => o.status === "new").length;

    document.getElementById("kpi-served").innerText =
        "Served : " + allOrders.filter(o => o.status === "served").length;

    document.getElementById("kpi-paid").innerText =
        "Paid : " + allOrders.filter(o => o.status === "paid").length;

    document.getElementById("kpi-done").innerText =
        "Done : " + allOrders.filter(o => o.status === "done").length;
}

/* SEARCH LISTENER */
document.getElementById("searchBox").addEventListener("input", displayOrders);

/* EXPORT XLS */
function exportXLS() {
    const ws = XLSX.utils.json_to_sheet(allOrders);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Commandes");
    XLSX.writeFile(wb, "commandes.xlsx");
}

/* EXPORT PDF */
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let y = 10;

    allOrders.forEach(o => {
        const total = o.items.reduce((s, i) => s + i.price, 0);

        pdf.text(`Table ${o.table} | ${o.time} | ${o.status} | Total: ${total} FCFA`, 10, y);
        y += 8;

        o.items.forEach(i => {
            pdf.text(`- ${i.name} : ${i.price} FCFA`, 14, y);
            y += 6;
        });

        y += 8;
    });

    pdf.save("commandes.pdf");
}

/* SORT */
function toggleSort() {
    sortDirection = sortDirection === "desc" ? "asc" : "desc";
    loadOrders();
}

loadOrders();
</script>

</body>
</html>
